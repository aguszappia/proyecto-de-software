<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sitios Históricos{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    {% block extra_head %}{% endblock %}
</head>
<body class="app-shell">
    <div class="app-shell__backdrop"></div>
    <div class="app-shell__glow app-shell__glow--one"></div>
    <div class="app-shell__glow app-shell__glow--two"></div>

    <div class="app-shell__inner">
        <header class="topbar">
            <div class="topbar__content">
                <button class="menu-toggle" id="menu-toggle" type="button" aria-label="Abrir menú de navegación">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <a href="{{ url_for('home') }}" class="topbar-logo">
                    <span class="logo-icon" aria-hidden="true">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C7.581 2 4 5.436 4 9.772c0 5.176 6.332 11.393 7.305 12.302a1 1 0 0 0 1.39 0C13.668 21.165 20 14.948 20 9.772 20 5.436 16.419 2 12 2Zm0 17.306c-2.01-2.036-6-6.698-6-9.534C6 6.477 8.579 4 12 4s6 2.477 6 5.772c0 2.836-3.99 7.498-6 9.534Zm0-12.306a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm0 4a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z" fill="currentColor"/>
                        </svg>
                    </span>
                    <span class="logo-text">Sitios Históricos</span>
                </a>
                <div class="user-dropdown">
                    <button class="user-dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                        <span class="user-dropdown-label">Cuenta</span>
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M3 4l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="user-dropdown-menu" role="menu">
                        <a href="{{ url_for('users.me') }}" role="menuitem">Ver perfil</a>
                        <a href="{{ url_for('auth.logout') }}"
                           class="dropdown-item logout-trigger"
                           role="menuitem"
                           data-logout-url="{{ url_for('auth.logout') }}">
                           Cerrar sesión
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <div class="app-shell__body">
            <aside class="sidebar" id="sidebar" aria-label="Navegación principal">
                {% set current_endpoint = (request.endpoint or '') %}
                {% set current_path = (request.path or '') %}
                <nav class="sidebar-nav">
                    <ul>
                        <li>
                            <a {% if current_endpoint.startswith('public_sites.') or current_path.startswith(url_for('public_sites.show_public_sites')) %}class="active"{% endif %}
                               href="{{ url_for('public_sites.show_public_sites') }}">
                                <span>Visualizar sitios históricos</span>
                            </a>
                        </li>
                        {% set role = session.get('user_role') %}
                        {% set can_manage_users = has_permission('user_index') %}
                        {% set can_manage_sites = has_permission('site_index') %}
                        {% set can_validate_proposals = has_permission('proposals_validate') %}
                        {% set can_moderate_reviews = has_permission('reviews_moderate') %}

                        {% if can_manage_sites %}
                            <li>
                                <a {% if current_endpoint.startswith('sites.') %}class="active"{% endif %}
                                   href="{{ url_for('sites.index') }}">
                                    <span>Gestión de sitios históricos</span>
                                </a>
                            </li>
                        {% endif %}
                        {% if can_validate_proposals %}
                            <li>
                                <a {% if current_endpoint == 'validacion_propuestas' %}class="active"{% endif %}
                                   href="{{ url_for('validacion_propuestas') }}">
                                    <span>Validación de propuestas</span>
                                </a>
                            </li>
                        {% endif %}
                        {% if can_moderate_reviews %}
                            <li>
                                <a {% if current_endpoint == 'moderacion_reseñas' or current_endpoint.startswith('reviews.') %}class="active"{% endif %}
                                   href="{{ url_for('moderacion_reseñas') }}">
                                    <span>Moderación de reseñas</span>
                                </a>
                            </li>
                        {% endif %}

                        {% if role in ['sysadmin', 'admin'] %}
                            <li>
                                <a {% if current_endpoint.startswith('tags.') %}class="active"{% endif %}
                                   href="{{ url_for('tags.index') }}">
                                    <span>Gestión de etiquetas</span>
                                </a>
                            </li>
                        {% endif %}
                        {% if can_manage_users %}
                            <li>
                                <a {% if current_endpoint.startswith('users.') %}class="active"{% endif %}
                                   href="{{ url_for('users.index') }}">
                                    <span>Gestión de usuarios</span>
                                </a>
                            </li>
                        {% endif %}
                        {% if role == 'sysadmin' %}
                            <li>
                                <a {% if current_endpoint == 'featureflags' %}class="active"{% endif %}
                                   href="{{ url_for('featureflags') }}">
                                    <span>Feature Flags</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </aside>

            <main class="main-content">
                <div class="content-inner">
                    {% with messages = get_flashed_messages(with_categories=True) %}
                        {% if messages %}
                            <div class="flash-container">
                                {% for category, message in messages %}
                                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endwith %}

                    {% block content %}
                    <div class="content-placeholder">
                        <h1>Bienvenido al Contenido Principal</h1>
                        <p>Aquí se cargará el contenido específico de cada módulo.</p>
                    </div>
                    {% endblock %}
                </div>
            </main>
        </div>
    </div>

    <div id="logout-modal" class="confirm-modal" hidden>
        <div class="confirm-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="logout-modal-title">
            <h2 id="logout-modal-title">Cerrar sesión</h2>
            <p>¿Seguro que querés cerrar sesión? Perderás el acceso hasta volver a iniciar.</p>
            <div class="confirm-modal__actions">
                <button type="button" class="secondary-button" data-cancel>Cancelar</button>
                <button type="button" class="danger-button" data-confirm>Salir</button>
            </div>
        </div>
    </div>

    <script>
        const menuToggle = document.getElementById('menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const userDropdownToggle = document.querySelector('.user-dropdown-toggle');
        const userDropdownMenu = document.querySelector('.user-dropdown-menu');

        function setSidebarOpen(open) {
            if (open) {
                document.body.classList.add('sidebar-open');
                sidebarOverlay.style.display = 'block';
            } else {
                document.body.classList.remove('sidebar-open');
                sidebarOverlay.style.display = 'none';
            }
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                setSidebarOpen(!document.body.classList.contains('sidebar-open'));
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => setSidebarOpen(false));
        }

        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', event => {
                document.querySelectorAll('.sidebar-nav a').forEach(el => el.classList.remove('active'));
                event.target.classList.add('active');
                if (window.innerWidth <= 768) {
                    setSidebarOpen(false);
                }
            });
        });

        if (userDropdownToggle && userDropdownMenu) {
            const dropdown = userDropdownToggle.closest('.user-dropdown');
            userDropdownToggle.addEventListener('click', function () {
                const expanded = this.getAttribute('aria-expanded') === 'true';
                const nextState = !expanded;
                this.setAttribute('aria-expanded', nextState ? 'true' : 'false');
                if (dropdown) {
                    dropdown.classList.toggle('is-open', nextState);
                }
            });

            window.addEventListener('click', event => {
                if (dropdown && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('is-open');
                    userDropdownToggle.setAttribute('aria-expanded', 'false');
                }
            });

            userDropdownMenu.querySelectorAll('a, button').forEach(item => {
                item.addEventListener('click', () => {
                    if (dropdown) {
                        dropdown.classList.remove('is-open');
                    }
                    userDropdownToggle.setAttribute('aria-expanded', 'false');
                });
            });
        }
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) {
            const logoutTriggers = document.querySelectorAll('.logout-trigger');
            const confirmButton = logoutModal.querySelector('[data-confirm]');
            const cancelButton = logoutModal.querySelector('[data-cancel]');
            if (!confirmButton || !cancelButton) {
                console.warn('Logout modal is missing buttons.');
            } else {
                let pendingUrl = null;
                let lastFocused = null;

                function openLogoutModal(url, trigger) {
                    pendingUrl = url;
                    lastFocused = trigger;
                    logoutModal.hidden = false;
                    logoutModal.classList.add('is-open');
                    confirmButton.focus();
                }

                function closeLogoutModal() {
                    logoutModal.classList.remove('is-open');
                    logoutModal.hidden = true;
                    pendingUrl = null;
                    if (lastFocused) {
                        lastFocused.focus();
                        lastFocused = null;
                    }
                }

                logoutTriggers.forEach(trigger => {
                    trigger.addEventListener('click', event => {
                        event.preventDefault();
                        const url = trigger.dataset.logoutUrl || trigger.getAttribute('href');
                        if (!url) {
                            return;
                        }
                        openLogoutModal(url, trigger);
                    });
                });

                confirmButton.addEventListener('click', () => {
                    const url = pendingUrl;
                    closeLogoutModal();
                    if (url) {
                        window.location.href = url;
                    }
                });
                cancelButton.addEventListener('click', closeLogoutModal);
                logoutModal.addEventListener('click', event => {
                    if (event.target === logoutModal) {
                        closeLogoutModal();
                    }
                });
                logoutModal.addEventListener('keydown', event => {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        closeLogoutModal();
                    }
                });
            }
        }
    </script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>
