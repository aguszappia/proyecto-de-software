{# admin/src/web/templates/flags/featureflags.html #}
{% extends "layout.html" %}

{% block title %}Feature Flags{% endblock %}

{% block content %}
<div class="module-header">
  <h1>Feature Flags</h1>
</div>

{% if flags %}
  <div class="table-wrapper">
    <style>
      .flag-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .flag-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.45);
        z-index: 3000;
      }
      .flag-modal[hidden] {
        display: none;
      }
      .flag-modal__dialog {
        background: #fff;
        border-radius: 16px;
        width: min(480px, 90vw);
        padding: 24px;
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .flag-modal__title {
        margin: 0;
        font-size: 1.25rem;
      }
      .flag-modal textarea {
        width: 100%;
        min-height: 120px;
        resize: none;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--color-text, #0f172a);
        padding: 14px 16px;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: rgba(255, 255, 255, 0.96);
        transition: border 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
      }
      .flag-modal textarea::placeholder {
        color: rgba(100, 116, 139, 0.6);
      }
      .flag-modal textarea:focus {
        border-color: var(--color-primary, #2563eb);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
        outline: none;
        transform: translateY(-1px);
      }
      .flag-modal__footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }
      .flag-modal__close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: transparent;
        color: var(--color-text, #0f172a);
        font-size: 1.2rem;
        cursor: pointer;
        display: grid;
        place-items: center;
      }
      .flag-modal__close::before {
        content: "×";
        line-height: 1;
      }
      .flag-modal__close:hover {
        background: rgba(226, 232, 240, 0.6);
      }
      .flag-modal__counter {
        font-size: 0.85rem;
        color: var(--color-text-muted);
        text-align: right;
      }
      .flag-modal__error {
        color: var(--color-danger, #ef4444);
        font-size: 0.85rem;
        min-height: 1.2em;
      }
    </style>
    <table class="data-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Última modificación</th>
          <th>Estado</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for flag in flags %}
          {% set default_message = default_messages.get(flag.key) %}
          <tr>
            <td>
              <strong>{{ flag.name }}</strong>
            </td>
            <td>{{ flag.description or 'Sin descripción' }}</td>
            <td>
              {% set updated_user = flag.updated_by %}
              {% if updated_user and flag.updated_at %}
                <div class="flag-updated">
                  <span class="flag-updated__user">{{ updated_user.first_name }} {{ updated_user.last_name }}</span>
                  <span class="flag-updated__time">{{ flag.updated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <span class="status-badge {{ 'status-active' if flag.enabled else 'status-inactive' }}">
                {{ 'ON' if flag.enabled else 'OFF' }}
              </span>
            </td>
            <td class="actions actions--flag">
              <div class="flag-actions">
                {% if flag.enabled %}
                  <form method="post"
                        action="{{ url_for('featureflags.manage') }}"
                        class="flag-form flag-form--disable">
                    <input type="hidden" name="flag_key" value="{{ flag.key }}">
                    <input type="hidden" name="enabled" value="false">
                    <input type="hidden" name="message" value="">
                    <button type="button"
                            class="secondary-button flag-disable-button"
                            data-flag-name="{{ flag.name }}"
                            data-flag-key="{{ flag.key }}"
                            data-default-message="{{ (default_message or '')|e }}"
                            data-max-message="{{ max_message_length }}">
                      Desactivar
                    </button>
                  </form>
                {% else %}
                  <form method="post"
                        action="{{ url_for('featureflags.manage') }}"
                        class="flag-form flag-form--enable">
                    <input type="hidden" name="flag_key" value="{{ flag.key }}">
                    <input type="hidden" name="enabled" value="true">
                    <input type="hidden" name="message" value="">
                    <button type="button"
                            class="primary-button flag-activate-button"
                            data-flag-name="{{ flag.name }}"
                            data-flag-key="{{ flag.key }}"
                            data-default-message="{{ default_message or '' }}"
                            data-max-message="{{ max_message_length }}">
                      Activar
                    </button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="flag-message-modal" class="flag-modal" hidden>
    <div class="flag-modal__dialog" role="dialog" aria-modal="true">
      <h2 class="flag-modal__title" data-modal-title>Activar modo mantenimiento</h2>
      <p data-modal-description>Ingresá un mensaje para activar este flag.</p>
      <textarea maxlength="{{ max_message_length }}"></textarea>
      <div class="flag-modal__counter" data-modal-counter>0/{{ max_message_length }}</div>
      <div class="flag-modal__error" data-modal-error></div>
      <div class="flag-modal__footer">
        <button type="button" class="secondary-button" data-modal-cancel>Cancelar</button>
        <button type="button" class="primary-button" data-modal-confirm>Confirmar</button>
      </div>
      <button type="button" class="flag-modal__close" data-modal-close aria-label="Cerrar"></button>
    </div>
  </div>
{% else %}
  <p>No hay feature flags cargados.</p>
{% endif %}
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function() {
      const modal = document.getElementById('flag-message-modal');
      if (!modal) {
        return;
      }
      const closeBtn = modal.querySelector('[data-modal-close]');
      const cancelBtn = modal.querySelector('[data-modal-cancel]');
      const confirmBtn = modal.querySelector('[data-modal-confirm]');
      const textarea = modal.querySelector('textarea');
      const counter = modal.querySelector('[data-modal-counter]');
      const description = modal.querySelector('[data-modal-description]');
      const errorBox = modal.querySelector('[data-modal-error]');
      const titleNode = modal.querySelector('[data-modal-title]');
      const REVIEWS_FLAG_KEY = 'reviews_enabled';
      let maxLength = parseInt(textarea.getAttribute('maxlength') || '0', 10) || {{ max_message_length }};
      let activeForm = null;
      let flagName = '';
      let modalConfig = {
        showTextarea: true,
        requireMessage: true,
      };

      function updateCounter(value) {
        if (!counter) return;
        counter.textContent = `${value.length}/${maxLength}`;
      }

      function configureTextarea(showTextarea) {
        if (showTextarea) {
          textarea.removeAttribute('readonly');
          textarea.style.display = 'block';
          if (counter) {
            counter.style.display = 'block';
          }
        } else {
          textarea.setAttribute('readonly', 'readonly');
          textarea.style.display = 'none';
          if (counter) {
            counter.style.display = 'none';
          }
        }
      }

      function openModal(form, defaults) {
        activeForm = form;
        flagName = defaults.name;
        modalConfig = {
          showTextarea: Boolean(defaults.showTextarea),
          requireMessage: Boolean(defaults.requireMessage),
        };
        maxLength = defaults.maxLength || maxLength;
        textarea.value = defaults.message || '';
        configureTextarea(modalConfig.showTextarea);
        if (modalConfig.showTextarea) {
          textarea.setAttribute('maxlength', maxLength.toString());
        }
        if (description) {
          description.textContent = defaults.description || '';
        }
        confirmBtn.textContent = defaults.confirmLabel || 'Confirmar';
        updateCounter(textarea.value);
        if (errorBox) {
          errorBox.textContent = '';
        }
        if (titleNode) {
          titleNode.textContent = defaults.title || '';
        }
        modal.hidden = false;
        modal.classList.add('is-open');
        if (modalConfig.showTextarea) {
          textarea.focus();
        } else {
          confirmBtn.focus();
        }
      }

      function closeModal() {
        modal.classList.remove('is-open');
        modal.hidden = true;
        activeForm = null;
        flagName = '';
      }

      function handleConfirm() {
        if (!activeForm) {
          closeModal();
          return;
        }
        let message = textarea.value.trim();
        if (modalConfig.showTextarea) {
          if (!message) {
            if (modalConfig.requireMessage) {
              if (errorBox) {
                errorBox.textContent = 'Ingresá un mensaje para continuar.';
              }
              textarea.focus();
              return;
            }
          }
          if (message.length > maxLength) {
            if (errorBox) {
              errorBox.textContent = `El mensaje supera el máximo de ${maxLength} caracteres.`;
            }
            textarea.focus();
            return;
          }
        } else {
          message = '';
        }
        const formToSubmit = activeForm;
        const messageInput = formToSubmit.querySelector('input[name="message"]');
        if (messageInput) {
          messageInput.value = message;
        }
        closeModal();
        formToSubmit.submit();
      }

      const buttons = document.querySelectorAll('.flag-activate-button');
      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const form = button.closest('form');
          if (!form) return;
          const flagKey = button.dataset.flagKey || '';
          const name = button.dataset.flagName || 'la funcionalidad';
          const hasMessage = flagKey !== REVIEWS_FLAG_KEY;
          if (!hasMessage) {
            openModal(form, {
              message: '',
              name,
              showTextarea: false,
              requireMessage: false,
              description: `¿Querés activar ${name}?`,
              confirmLabel: 'Activar',
              title: `Activar ${name}`,
            });
            return;
          }
          openModal(form, {
            message: button.dataset.defaultMessage || '',
            maxLength: parseInt(button.dataset.maxMessage || '0', 10) || {{ max_message_length }},
            name,
            showTextarea: true,
            requireMessage: true,
            description: 'Ingresá un mensaje para activar este flag.',
            confirmLabel: 'Activar',
            title: `Activar ${name}`,
          });
        });
      });
      const disableButtons = document.querySelectorAll('.flag-disable-button');
      disableButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const form = button.closest('form');
          if (!form) return;
          const name = button.dataset.flagName || 'la funcionalidad';
          const flagKey = button.dataset.flagKey || '';
          const requireMessage = flagKey === REVIEWS_FLAG_KEY;
          openModal(form, {
            message: requireMessage ? button.dataset.defaultMessage || '' : '',
            maxLength: parseInt(button.dataset.maxMessage || '0', 10) || {{ max_message_length }},
            name,
            showTextarea: requireMessage,
            requireMessage,
            description: requireMessage
              ? 'Ingresá un mensaje para informar la desactivación.'
              : `¿Querés desactivar ${name}?`,
            confirmLabel: 'Desactivar',
            title: `Desactivar ${name}`,
          });
        });
      });

      textarea.addEventListener('input', (event) => {
        const value = event.target.value;
        updateCounter(value);
        if (value.trim().length > 0 && value.length <= maxLength) {
          if (errorBox) {
            errorBox.textContent = '';
          }
        }
      });

      [closeBtn, cancelBtn].forEach((element) => {
        if (element) {
          element.addEventListener('click', () => closeModal());
        }
      });

      confirmBtn.addEventListener('click', handleConfirm);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
      modal.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeModal();
        }
      });
    })();
  </script>
{% endblock %}
