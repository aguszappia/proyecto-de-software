{% extends "layout.html" %}

{% block title %}Gestión de usuarios{% endblock %}

{% block content %}
{% set role_labels = {
    'public': 'Usuario público',
    'editor': 'Editor',
    'admin': 'Administrador',
    'sysadmin': 'System Admin',
} %}
{% set can_create = has_permission('user_new') %}
{% set can_view = has_permission('user_show') %}
{% set can_edit = has_permission('user_update') %}
{% set can_delete = has_permission('user_destroy') %}
<div class="module-header">
    <h1>Gestión de usuarios</h1>
    {% if can_create %}
        <a class="primary-button" href="{{ url_for('users.new') }}">Nuevo usuario</a>
    {% endif %}
</div>

<form class="filters" method="get" action="{{ url_for('users.index') }}">
    <div class="filter-group">
        <label for="email">Email</label>
        <input type="text" id="email" name="email" value="{{ filters.email }}" placeholder="Buscar por email">
    </div>
    <div class="filter-group">
        <label for="role">Rol</label>
        <select id="role" name="role">
            <option value="">Todos</option>
            {% for role in roles %}
                <option value="{{ role.value }}" {% if filters.role == role.value %}selected{% endif %}>{{ role_labels[role.value] }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="active">Activo</label>
        <select id="active" name="active">
            <option value="">Todos</option>
            <option value="true" {% if filters.active == 'true' %}selected{% endif %}>Sí</option>
            <option value="false" {% if filters.active == 'false' %}selected{% endif %}>No</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="order">Orden</label>
        <select id="order" name="order">
            <option value="-created_at" {% if filters.order == '-created_at' %}selected{% endif %}>Más recientes primero</option>
            <option value="created_at" {% if filters.order == 'created_at' %}selected{% endif %}>Más antiguos primero</option>
        </select>
    </div>
    <div class="filter-actions">
        <button type="submit" class="primary-button filters-apply">Aplicar filtros</button>
        <a class="secondary-button" href="{{ url_for('users.index') }}">Limpiar</a>
    </div>
</form>

{% if pagination.items %}
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                    <th>Activo</th>
                    <th>Creado</th>
                    <th class="actions">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for user in pagination.items %}
                    <tr>
                        <td>{{ user.email }}</td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        <td>{{ role_labels[user.role] }}</td>
                        <td>
                            {% if user.is_active %}
                                <span class="status-badge status-active">Sí</span>
                            {% else %}
                                <span class="status-badge status-inactive">No</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
                        <td class="actions">
                            {% if can_view %}
                                <a class="link-button action-item" href="{{ url_for('users.show', user_id=user.id) }}">Ver</a>
                            {% endif %}
                            {% if can_edit %}
                                {% if user.is_active %}
                                    {% if user.role != 'admin' and user.role != 'sysadmin'%}
                                        <form method="post"
                                            action="{{ url_for('users.deactivate', user_id=user.id) }}"
                                            class="inline-form action-item"
                                            onsubmit="return confirm('¿Seguro que querés desactivar este usuario?');">
                                        <button type="submit" class="secondary-button">Desactivar</button>
                                        </form>
                                    {% else %}
                                        <button type="button" class="secondary-button action-item" disabled title="No se puede desactivar un Administrador">Desactivar</button>
                                    {% endif %}
                                {% else %}
                                    <form method="post"
                                            action="{{ url_for('users.activate', user_id=user.id) }}"
                                            class="inline-form action-item">
                                        <button type="submit" class="success-button">Activar</button>
                                    </form>
                                {% endif %}

                                <a class="link-button action-item" href="{{ url_for('users.edit', user_id=user.id) }}">Editar</a>
                            {% endif %}

                            {% if can_delete %}
                                <form method="post"
                                    action="{{ url_for('users.destroy', user_id=user.id) }}"
                                    class="inline-form action-item"
                                    onsubmit="return confirm('¿Eliminar usuario?');">
                                <button type="submit" class="danger-button">Eliminar</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        {% if pagination.page > 1 %}
            <a href="{{ url_for('users.index', email=filters.email, role=filters.role, active=filters.active, order=filters.order, page=pagination.page - 1) }}">Anterior</a>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
        {% if pagination.page < pagination.pages %}
            <a href="{{ url_for('users.index', email=filters.email, role=filters.role, active=filters.active, order=filters.order, page=pagination.page + 1) }}">Siguiente</a>
        {% endif %}
    </div>
{% else %}
    <p>No se encontraron usuarios con los filtros seleccionados.</p>
{% endif %}
{% endblock %}
message.txt
5 KB
