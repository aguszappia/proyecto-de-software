{% extends "layout.html" %}

{% block title %}{{ 'Editar' if is_edit else 'Crear' }} sitio histórico{% endblock %}

{% block extra_head %}
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
>
<style>
  .site-map .leaflet-top.leaflet-left {
    top: 16px;
    left: 16px;
  }
  .site-map .leaflet-control {
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.18);
    border-radius: 6px;
  }
</style>
{% endblock %}

{% block content %}
<section class="container content-stack">
  <header class="section-heading">
    <span class="section-kicker">Gestión de sitios</span>
    <h1 class="page-title">
      {{ 'Editar sitio histórico' if is_edit else 'Nuevo sitio histórico' }}
    </h1>
    <p class="section-subtitle">
      Completá la información clave y seleccioná la ubicación para mantener el registro actualizado.
    </p>
  </header>

  <div class="site-form">
    <form method="post" class="site-form__form">
        <div class="form-grid">
            <div class="form-field">
                <label for="name">Nombre del sitio</label>
                <input type="text" id="name" name="name" required value="{{ form_values.name }}">
            </div>
            <div class="form-field">
                <label for="short_description">Descripción breve</label>
                <input type="text" id="short_description" name="short_description" required value="{{ form_values.short_description }}">
            </div>
            <div class="form-field form-field--full">
                <label for="full_description">Descripción completa</label>
                <textarea id="full_description" name="full_description" rows="4" required>{{ form_values.full_description }}</textarea>
            </div>
            <div class="form-field">
                <label for="city">Ciudad</label>
                <input type="text" id="city" name="city" required value="{{ form_values.city }}">
            </div>
            <div class="form-field">
                <label for="province">Provincia</label>
                <select id="province" name="province" required>
                    <option value="">Seleccioná una provincia</option>
                    {% for province in provinces %}
                        <option value="{{ province }}" {% if form_values.province == province %}selected{% endif %}>{{ province }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label for="conservation_status">Estado de conservación</label>
                <select id="conservation_status" name="conservation_status" required>
                    <option value="">Seleccioná una opción</option>
                    {% for status in conservation_statuses %}
                        <option value="{{ status.value }}" {% if form_values.conservation_status == status.value %}selected{% endif %}>{{ status.value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label for="category">Categoría</label>
                <select id="category" name="category" required>
                    <option value="">Seleccioná una categoría</option>
                    {% for category in categories %}
                        <option value="{{ category.value }}" {% if form_values.category == category.value %}selected{% endif %}>{{ category.value }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label for="inaguration_year">Año de inauguración</label>
                <input type="number" id="inaguration_year" name="inaguration_year" min="0" value="{{ form_values.inaguration_year }}" required>
            </div>
            <div class="form-field form-field--full">
                <label for="tags-input">Etiquetas</label>
                <div class="tag-selector" data-all-tags='[{% for tag in tags %}{"id":{{ tag.id }},"name":"{{ tag.name|e }}"}{% if not loop.last %},{% endif %}{% endfor %}]'>
                    <input type="text" id="tags-input" class="tag-selector__input" placeholder="Escribí para filtrar etiquetas" autocomplete="off">
                    <div class="tag-selector__list" role="listbox"></div>
                    <div class="tag-selector__chips" data-selected-tags>
                        {% for tag in tags %}
                            {% if tag.id in form_values.tag_ids %}
                                <span class="tag-chip" data-tag-id="{{ tag.id }}">
                                    <span>{{ tag.name }}</span>
                                    <button type="button" aria-label="Quitar {{ tag.name }}">×</button>
                                    <input type="hidden" name="tags" value="{{ tag.id }}">
                                </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                <small>Seleccioná una o más etiquetas para clasificar el sitio.</small>
            </div>
            <div class="form-field form-field--checkbox">
                <label>
                    <input type="checkbox" name="is_visible" {% if form_values.is_visible %}checked{% endif %}>
                    Marcar como visible en el portal público
                </label>
            </div>
        </div>

        <div class="map-section">
            <label for="site-map">Ubicación geográfica</label>
            <div id="site-map" class="site-map" aria-live="polite"></div>
            <div class="coordinate-inputs">
                <div>
                    <label for="latitude-input">Latitud</label>
                    <input type="text" id="latitude-input" name="latitude" value="{{ form_values.latitude }}" readonly>
                </div>
                <div>
                    <label for="longitude-input">Longitud</label>
                    <input type="text" id="longitude-input" name="longitude" value="{{ form_values.longitude }}" readonly>
                </div>
            </div>
            <small>Hacé clic en el mapa para elegir las coordenadas del sitio histórico.</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="primary-button">Guardar</button>
            <a href="{{ url_for('sites.index') }}" class="secondary-button">Cancelar</a>
        </div>
    </form>
</div>
{% set can_view_history = has_permission('site_history_view') %}
{% if is_edit and site_id %}
  <div class="site-images-panel">
      <h2>Galería del sitio</h2>
      <p>Subí, ordená y definí la portada antes de publicar el sitio en el portal.</p>
      <a class="secondary-button" href="{{ url_for('site_images.manage', site_id=site_id) }}">Administrar imágenes</a>
  </div>
{% endif %}
{% if is_edit and site_id and can_view_history %}
  <div class="site-history-panel">
      <h2>Historial de cambios</h2>
      <p>Podés revisar todos los movimientos realizados sobre este sitio.</p>
      <a class="secondary-button" href="{{ url_for('sites_history.view_history', site_id=site_id) }}">Ver historial completo</a>
  </div>
{% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
></script>
<script>
(function() {
    const mapElement = document.getElementById('site-map');
        const latInput = document.getElementById('latitude-input');
        const lngInput = document.getElementById('longitude-input');
        if (!mapElement || !latInput || !lngInput) {
            return;
        }

        const parsedLat = parseFloat(latInput.value);
        const parsedLng = parseFloat(lngInput.value);
        const hasCoords = !Number.isNaN(parsedLat) && !Number.isNaN(parsedLng);

        const defaultCoords = hasCoords ? [parsedLat, parsedLng] : [-34.6037, -58.3816];
        const defaultZoom = hasCoords ? 14 : 5;

        const map = L.map(mapElement).setView(defaultCoords, defaultZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker = null;
        if (hasCoords) {
            marker = L.marker(defaultCoords).addTo(map);
        }

        map.on('click', function(event) {
            const { lat, lng } = event.latlng;
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);

            if (marker) {
                marker.setLatLng(event.latlng);
            } else {
                marker = L.marker(event.latlng).addTo(map);
            }
    });
})();

  (function() {
    const selector = document.querySelector('.tag-selector');
    if (!selector) {
      return;
    }

    const input = selector.querySelector('.tag-selector__input');
    const list = selector.querySelector('.tag-selector__list');
    const chipsContainer = selector.querySelector('[data-selected-tags]');

    let allTags = [];
    try {
      allTags = JSON.parse(selector.dataset.allTags || '[]');
    } catch (error) {
      allTags = [];
    }

    const selectedIds = new Set();

    function renderOptions(filterText) {
      list.innerHTML = '';
      const text = (filterText || '').toLowerCase();
      const available = allTags.filter(tag => {
        if (selectedIds.has(String(tag.id))) {
          return false;
        }
        if (!text) {
          return true;
        }
        return tag.name.toLowerCase().includes(text);
      });

      if (!available.length) {
        const empty = document.createElement('div');
        empty.className = 'tag-selector__option';
        empty.textContent = text ? 'Sin coincidencias' : 'No hay etiquetas disponibles';
        empty.setAttribute('aria-disabled', 'true');
        list.append(empty);
        list.classList.add('is-visible');
        return;
      }

      available.forEach(tag => {
        const option = document.createElement('div');
        option.className = 'tag-selector__option';
        option.setAttribute('role', 'option');
        option.dataset.tagId = tag.id;
        option.textContent = tag.name;
        option.addEventListener('mousedown', event => {
          event.preventDefault();
          addTag(tag);
        });
        list.append(option);
      });
      list.classList.add('is-visible');
    }

    function hideOptions() {
      list.classList.remove('is-visible');
    }

    function createChip(tag) {
      const chip = document.createElement('span');
      chip.className = 'tag-chip';
      chip.dataset.tagId = String(tag.id);

      const label = document.createElement('span');
      label.textContent = tag.name;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.setAttribute('aria-label', `Quitar ${tag.name}`);
      removeBtn.textContent = '×';

      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'tags';
      hidden.value = tag.id;

      removeBtn.addEventListener('click', () => {
        selectedIds.delete(String(tag.id));
        chip.remove();
        renderOptions(input.value.trim());
      });

      chip.append(label, removeBtn, hidden);
      chipsContainer.append(chip);
    }

    function addTag(tag) {
      const id = String(tag.id);
      if (selectedIds.has(id)) {
        return;
      }
      selectedIds.add(id);
      createChip(tag);
      input.value = '';
      hideOptions();
    }

    function initSelected() {
      const existing = Array.from(chipsContainer.querySelectorAll('.tag-chip input[type="hidden"][name="tags"]')).map(input => input.value);
      chipsContainer.innerHTML = '';
      selectedIds.clear();

      existing.forEach(id => {
        const tag = allTags.find(item => String(item.id) === String(id));
        if (tag) {
          selectedIds.add(String(tag.id));
          createChip(tag);
        }
      });
      hideOptions();
    }

    input.addEventListener('focus', () => {
      renderOptions(input.value.trim());
    });

    input.addEventListener('input', () => {
      renderOptions(input.value.trim());
    });

    input.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        event.preventDefault();
        const firstOption = list.querySelector('.tag-selector__option[role="option"]');
        if (firstOption) {
          const tag = allTags.find(item => String(item.id) === String(firstOption.dataset.tagId));
          if (tag) {
            addTag(tag);
          }
        }
      } else if (event.key === 'Escape') {
        hideOptions();
        input.blur();
      }
    });

    document.addEventListener('click', event => {
      if (!selector.contains(event.target)) {
        hideOptions();
      }
    });

    initSelected();
  })();
</script>
{% endblock %}
