{% extends "layout.html" %}

{% block title %}Gestión de Sitios Históricos{% endblock %}

{% block content %}
{% set can_create_site = has_permission('site_new') %}
{% set can_export_sites = has_permission('site_export') %}
{% set can_update_site = has_permission('site_update') %}
{% set can_delete_site = has_permission('site_destroy') %}

<section class="container management-card">
  <div class="module-header">
      <h1>Búsqueda de sitios históricos</h1>
      <span class="results-count">{{ pagination.total }} resultados</span>
  </div>

  <div class="actions-bar">
    {% if can_create_site %}
        <a class="primary-button" href="{{ url_for('sites.create') }}">Agregar sitio histórico</a>
    {% endif %}
    {% if can_export_sites %}
        <form class="export-form" method="get" action="{{ url_for('sites.export_sites') }}">
            <input type="hidden" name="city" value="{{ filters.city }}">
            <input type="hidden" name="province" value="{{ filters.province }}">
            <input type="hidden" name="q" value="{{ filters.q }}">
            <input type="hidden" name="conservation_status" value="{{ filters.conservation_status }}">
            <input type="hidden" name="created_from" value="{{ filters.created_from }}">
            <input type="hidden" name="created_to" value="{{ filters.created_to }}">
            <input type="hidden" name="sort_by" value="{{ filters.sort_by }}">
            <input type="hidden" name="sort_dir" value="{{ filters.sort_dir }}">
            <input type="hidden" name="is_visible" value="{{ filters.is_visible }}">
            {% for tag_id in filters.tags %}
                <input type="hidden" name="tags" value="{{ tag_id }}">
            {% endfor %}
            <button type="button"
                    class="secondary-button export-button"
                    data-confirm-trigger
                    data-confirm-mode="submit"
                    data-confirm-title="Exportar sitios"
                    data-confirm-message="¿Generar el archivo CSV con los sitios filtrados?"
                    data-confirm-accept="Exportar"
                    data-confirm-variant="primary">
                Exportar sitios
            </button>
        </form>
    {% endif %}
  </div>

  <form class="filters" method="get" action="{{ url_for('sites.index') }}">
    <div class="filters-row">
        <div class="filter-group">
            <label for="city">Ciudad</label>
            <input type="text" id="city" name="city" value="{{ filters.city }}" placeholder="Buscar por ciudad">
        </div>
        <div class="filter-group">
            <label for="province">Provincia</label>
            <select id="province" name="province">
                <option value="">Todas</option>
                {% for prov in provinces %}
                    <option value="{{ prov }}" {% if filters.province == prov %}selected{% endif %}>{{ prov }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="q">Texto libre</label>
            <input type="text" id="q" name="q" value="{{ filters.q }}" placeholder="Buscar en nombre o descripción">
        </div>
        <div class="filter-group">
            <label for="is_visible">Estado de visibilidad</label>
            <select id="is_visible" name="is_visible">
                <option value="">Todos</option>
                <option value="true" {% if filters.is_visible == 'true' %}selected{% endif %}>Visible</option>
                <option value="false" {% if filters.is_visible == 'false' %}selected{% endif %}>Oculto</option>
            </select>
        </div>
    </div>

    <div class="filters-row">
        <div class="filter-group">
            <label for="conservation_status">Estado de conservación</label>
            <select id="conservation_status" name="conservation_status">
                <option value="">Todos</option>
                {% for status in conservation_statuses %}
                    <option value="{{ status.value }}" {% if filters.conservation_status == status.value %}selected{% endif %}>{{ status.value }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="sort_by">Ordenar por</label>
            <select id="sort_by" name="sort_by">
                <option value="created_at" {% if filters.sort_by == 'created_at' %}selected{% endif %}>Fecha de registro</option>
                <option value="name" {% if filters.sort_by == 'name' %}selected{% endif %}>Nombre</option>
                <option value="city" {% if filters.sort_by == 'city' %}selected{% endif %}>Ciudad</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="sort_dir">Orden</label>
            <select id="sort_dir" name="sort_dir">
                <option value="asc" {% if filters.sort_dir == 'asc' %}selected{% endif %}>Ascendente</option>
                <option value="desc" {% if filters.sort_dir == 'desc' %}selected{% endif %}>Descendente</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="tags-input">Etiquetas</label>
            <div class="tag-selector" data-all-tags='[{% for tag in tags %}{"id":{{ tag.id }},"name":"{{ tag.name|e }}"}{% if not loop.last %},{% endif %}{% endfor %}]'>
                <input type="text" id="tags-input" class="tag-selector__input" placeholder="Escribí para filtrar etiquetas" autocomplete="off">
                <div class="tag-selector__list" role="listbox"></div>
                <div class="tag-selector__chips" data-selected-tags>
                    {% for tag in tags %}
                        {% if tag.id in filters.tags %}
                            <span class="tag-chip" data-tag-id="{{ tag.id }}">
                                <span>{{ tag.name }}</span>
                                <button type="button" aria-label="Quitar {{ tag.name }}">×</button>
                                <input type="hidden" name="tags" value="{{ tag.id }}">
                            </span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="filters-row">
        <div class="filter-group">
            <label for="created_from">Fecha desde</label>
            <input type="date" id="created_from" name="created_from" value="{{ filters.created_from }}">
        </div>
        <div class="filter-group">
            <label for="created_to">Fecha hasta</label>
            <input type="date" id="created_to" name="created_to" value="{{ filters.created_to }}">
        </div>
    </div>
    <div class="filter-actions">
        <button type="submit" class="primary-button">Buscar</button>
        <a class="secondary-button" href="{{ url_for('sites.index') }}">Limpiar</a>
    </div>
</form>

{% if pagination.items %}
    <p class="results-summary">
        Mostrando {{ (pagination.page - 1) * pagination.per_page + 1 }}
        - {{ (pagination.page - 1) * pagination.per_page + pagination.items|length }}
        de {{ pagination.total }}
    </p>
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="cover-column">Portada</th>
                    <th>Nombre</th>
                    <th>Ciudad</th>
                    <th>Provincia</th>
                    <th>Estado</th>
                    <th>Visibilidad</th>
                    <th class="actions">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for site in pagination.items %}
                    <tr>
                        <td class="cover-column">
                            {% if site.cover_image_url %}
                                <img class="cover-thumb" src="{{ site.cover_image_url }}" alt="{{ site.cover_image_title or site.name }}">
                            {% else %}
                                <span class="cover-thumb cover-thumb--empty">Sin portada</span>
                            {% endif %}
                        </td>
                        <td>{{ site.name }}</td>
                        <td>{{ site.city }}</td>
                        <td>{{ site.province }}</td>
                        <td>{{ site.conservation_status }}</td>
                        <td>
                            {% if site.is_visible %}
                                <span class="status-badge status-active">Visible</span>
                            {% else %}
                                <span class="status-badge status-inactive">Oculto</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            {% if can_update_site %}
                                <a class="link-button" href="{{ url_for('sites.manage_images', site_id=site.id) }}">Imágenes</a>
                                <a class="secondary-button" href="{{ url_for('sites.edit', site_id=site.id) }}">Editar</a>
                            {% endif %}
                            {% if can_delete_site %}
                                <form method="post"
                                      action="{{ url_for('sites.remove', site_id=site.id) }}"
                                      class="inline-form">
                                    <button type="button"
                                            class="danger-button"
                                            data-confirm-trigger
                                            data-confirm-mode="submit"
                                            data-confirm-title="Eliminar sitio histórico"
                                            data-confirm-message="¿Seguro que querés eliminar este sitio histórico?"
                                            data-confirm-accept="Eliminar"
                                            data-confirm-variant="danger">
                                        Eliminar
                                    </button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="pagination">
        {% if prev_url %}
            <a href="{{ prev_url }}">Anterior</a>
        {% endif %}
        <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
        {% if next_url %}
            <a href="{{ next_url }}">Siguiente</a>
        {% endif %}
    </div>
{% else %}
    <p class="empty-state-message">Sin resultados</p>
{% endif %}

<section class="deleted-sites-section">
    <div class="deleted-sites-card">
        <div class="deleted-sites-card__content">
            <h2>Sitios eliminados</h2>
            <p>Revisá el historial completo de sitios que fueron dados de baja.</p>
        </div>
        <a class="secondary-button deleted-sites-toggle"
           href="{{ url_for('sites.deleted_list') }}">
            Ver Sitios Eliminados
        </a>
    </div>
</section>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function() {
      const selector = document.querySelector('.tag-selector');
      if (!selector) {
        return;
      }

      const input = selector.querySelector('.tag-selector__input');
      const list = selector.querySelector('.tag-selector__list');
      const chipsContainer = selector.querySelector('[data-selected-tags]');

      let allTags = [];
      try {
        allTags = JSON.parse(selector.dataset.allTags || '[]');
      } catch (error) {
        allTags = [];
      }

      const selectedIds = new Set();

      function createChip(tag) {
        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tagId = String(tag.id);

        const label = document.createElement('span');
        label.textContent = tag.name;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', `Quitar ${tag.name}`);
        removeBtn.textContent = '×';

        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'tags';
        hidden.value = tag.id;

        removeBtn.addEventListener('click', () => {
          selectedIds.delete(String(tag.id));
          chip.remove();
          renderOptions(input.value.trim());
        });

        chip.append(label, removeBtn, hidden);
        chipsContainer.append(chip);
      }

      function addTag(tag) {
        const id = String(tag.id);
        if (selectedIds.has(id)) {
          return;
        }
        selectedIds.add(id);
        createChip(tag);
        input.value = '';
        hideOptions();
      }

      function renderOptions(filterText) {
        list.innerHTML = '';
        const text = filterText.toLowerCase();
        const available = allTags.filter(tag => {
          if (selectedIds.has(String(tag.id))) {
            return false;
          }
          if (!text) {
            return true;
          }
          return tag.name.toLowerCase().includes(text);
        });

        if (!available.length) {
          const empty = document.createElement('div');
          empty.className = 'tag-selector__option';
          empty.textContent = text ? 'Sin coincidencias' : 'No hay etiquetas disponibles';
          empty.setAttribute('aria-disabled', 'true');
          list.append(empty);
          list.classList.add('is-visible');
          return;
        }

        available.forEach(tag => {
          const option = document.createElement('div');
          option.className = 'tag-selector__option';
          option.setAttribute('role', 'option');
          option.dataset.tagId = tag.id;
          option.textContent = tag.name;

          option.addEventListener('mousedown', event => {
            event.preventDefault();
            addTag(tag);
          });

          list.append(option);
        });
        list.classList.add('is-visible');
      }

      function hideOptions() {
        list.classList.remove('is-visible');
      }

      function initSelected() {
        const existing = Array.from(chipsContainer.querySelectorAll('.tag-chip input[type="hidden"][name="tags"]')).map(input => input.value);
        chipsContainer.innerHTML = '';
        selectedIds.clear();

        existing.forEach(id => {
          const tag = allTags.find(item => String(item.id) === String(id));
          if (tag) {
            addTag(tag);
          }
        });
        hideOptions();
      }

      input.addEventListener('focus', () => {
        renderOptions(input.value.trim());
      });

      input.addEventListener('input', () => {
        renderOptions(input.value.trim());
      });

      input.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const firstOption = list.querySelector('.tag-selector__option[role="option"]');
          if (firstOption) {
            const tag = allTags.find(item => String(item.id) === String(firstOption.dataset.tagId));
            if (tag) {
              addTag(tag);
              input.value = '';
            }
          }
          hideOptions();
        } else if (event.key === 'Escape') {
          hideOptions();
          input.blur();
        }
      });

      document.addEventListener('click', event => {
        if (!selector.contains(event.target)) {
          hideOptions();
        }
      });

      initSelected();
    })();
  </script>
{% endblock %}
